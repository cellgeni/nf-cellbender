//This fixes nf-core launch error: project <project-name> is currently stickied on revision: main 
manifest.defaultBranch = "main"


// Global default params, used in configs
params {
  // Process-specific parameters
  output_dir              = "cellbender-results"
  publish_mode            = 'copy'

  // Required parameters
  sample_table            = null
  mapper                  = null
  solo_quant              = ""

  // Optional parameters
  help                    = false
  version                 = "0.3"
  on_irods                = false
  qc_mode                 = 3
  cells                   = ""
  droplets                = ""
  epochs                  = ""
  fpr                     = ""
  lr                      = ""
  min_umi                 = ""

  // Containers
  cellbender_container_v3 = "cellbender0.3.0-pytorch2.3.1-cuda12.1.1-ubuntu22.04.sif"
  cellbender_container_v2 = "cellbender0.2.2-pytorch1.11-cuda11.3.1-R4.1.3.sif"
}

// Singularity environment parameters
singularity {
  enabled    = true
  autoMounts = true
  cacheDir   = '/nfs/cellgeni/singularity/images/'
  //runOptions = '-B /lustre,/nfs --nv'
  runOptions = '-B /lustre,/nfs'
}

// Configuring LSF job submission parameters for each process
executor {
  name           = 'lsf'
  perJobMemLimit = true
}

process {

  errorStrategy = 'retry'
  maxRetries    = 5

  withName: LoadFromIrods {
    cpus     = { 1 * task.attempt }
    memory   = { 2.GB * task.attempt }
    queue    = 'transfer'
    maxForks = 5
  }
  withName: RemoveBackground {
    // Pass parameters to the process
    ext.version       = params.version
    ext.cellbender_v2 = params.cellbender_container_v2
    ext.cellbender_v3 = params.cellbender_container_v3
    
    // Set the container options
    container        = "docker://quay.io/cellgeni/cellbender:${params.version}"
    clusterOptions   = ' -gpu "mode=shared:j_exclusive=no:gmem=6000:num=1"'
    containerOptions = '--nv'

    // Set the resources for the process
    cpus           = { 2 * task.attempt }
    memory         = { 30.GB * task.attempt }
    queue          = 'gpu-normal'
    maxForks       = 5
    publishDir     = [
      path: "${params.output_dir}",
      mode: "${params.publish_mode}",
    ]
  }
  withName: QualityControl {
    container  = "docker://quay.io/cellgeni/cellbender:${params.version}"
    cpus       = { 1 * task.attempt }
    memory     = { 4.GB * task.attempt }
    queue      = 'normal'
    publishDir = [
      path: "${params.output_dir}",
      mode: "${params.publish_mode}",
    ]
  }
}

// Capture exit codes from upstream processes when piping
process.shell = ['/bin/bash', '-euo', 'pipefail']

// Capturing Nextflow log files into a reports directory
timeline {
  enabled   = true
  file      = "execution-reports/timeline.html"
  overwrite = true
}

report {
  enabled   = true
  file      = "execution-reports/report.html"
  overwrite = true
}

trace {
  enabled   = true
  file      = "execution-reports/trace.txt"
  overwrite = true
}

// Unscoped options
cleanup = false
workDir = "nf-work"
